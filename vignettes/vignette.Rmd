---
title: "CancerAbstract Vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{CancerAbstract Vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style>
    pre {border: 0;}
    img {border: 0;}
</style>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 6, 
  fig.height = 5
)
```

```{r setup}
library(CancerAbstract)
library(ggplot2)
```

## Part I: Kriging Interpolation

Load the spatial transcriptomics data from package: 

- **ST_expr_data**, representing the spot-by-gene expression metrix normalized by Seurat::SCTransform. 

```{r}
ST_expr_data[1:5, 1:5]
```

- **spot_coord**, representing the physical location (coordinates) of every spots. It should have the same row names as the expression matrix. Here in the example, we have two columns 'imagerow' and 'imagecol' as X and Y coordinates in $\mu m$. 

```{r}
head(spot_coord)
```


### Apply Kriging method on ST data

As the first step of CancerAbstract, a Kriging interpolation is performed for a given gene. 

```{r, eval=FALSE}
Kriging_res <- SpatialKriging(spatial.data = ST_expr_data,  # spatial expression matrix
                              spatial.coord = spot_coord,   # coordinates
                              gene.id = "IFI6",             # gene id, a colname in spatial.data
                              predict.grid.size = 20,       # grid size for interpolation
                              Kriging.cutoff = 600,         # auotocorrelation effect range
                              Kriging.width = 30,           # bin widths in Kriging sampling
                              plot.dir = "./plots/Kriging/",# path to save figures
                              save.plot = F                 # plot or not; default is T
                              )
```

*SpatialKriging* contains 4 sub-functions that can be run separately as below:

- integrateCoordinate: based on sp::coordinates(), integrate the ST expression matrix (STEM) and coordiantes together into one object

- fitKriging: fit Kriging model on integrated data; should indicate specific gene id

- createGridDataframe: create the new grid based on the original spatial coordinates; so far only support creating a rectangle space with square tiles

- Kriging_predict: perform prediction / interpolation on newly created grid

```{r}
integrate_ST_data <- integrateCoordinate(ST_expr_data, spot_coord)
Kriging_model <- fitKriging(integrate_ST_data, "CALD1", save.plot = F)
finer_grid <- createGridDataframe(integrate_ST_data)
Kriging_predict <- predictKriging(integrate_ST_data,
                                  finer_grid,
                                  "CALD1",
                                  Kriging_model[[2]],
                                  save.plot = F)
Kriging_res <- data.frame(X = Kriging_predict@coords[,1],
                          Y = Kriging_predict@coords[,2],
                          var1.pred = Kriging_predict$var1.pred)
```

Visualization of the interpolation results

- We can visualize the Kriging result by ggplot2::geom_tile() functions, which is designed to plot the square tiles whose color represents the expression level of the gene. You can also generate this plot by CancerAbstract::gg_tile()

```{r}
ggplot(data = Kriging_res) + 
    geom_tile(aes(x = X, 
                  y = Y, 
                  fill = var1.pred)) + 
    scale_fill_gradient2(low = "darkblue", 
                         high = "yellow", 
                         mid = "purple", 
                         midpoint = max(Kriging_res$var1.pred, na.rm = T) / 2) +
    theme_bw() + 
    labs(x = "X / um", 
         y = "Y / um", 
         title = "CALD1 Kriging Interplocation", 
         fill = "CALD1") +
    theme(aspect.ratio = 1)
```

- As a comparison, one can also visualize the original spot-level data by CancerAbstract::gg_spot()

```{r}
gg_spot("CALD1", ST_expr_data, spot_coord)
```


## Part II: Weighted Voronoi Diagrams

In this vignette, we provide a toy example that includes cancer cell state data to generate the weighted Voronoi diagrams as the abstract of the given tumor. 

- After Kriging modeling on each cell state marker, we integrated the spatial distribution of all states by averaging their markers' relative expressions. Euclidean distances between every pair of states are calculated, and multidimensional scaling is used to help visualize the results.

- How the cell state (centroid) coordinates look like:

```{r}
head(Voronoi_centroid)
```

- The connections between states / centroids

```{r}
head(Voronoi_connections)
```

- Plot the Weighted Voronoi Diagrams (WVD)

```{r}
##  Calculate the Delaunay triangulation in WVD on tile-level
grid_max <- ceiling(max(abs(Voronoi_centroid[,1:2])))
grid_unit <- grid_max / 100
##  tmp_grid as the collection of tiles to do clustering; 
##    can be changed to other options
tmp_grid <- data.frame(X = rep(seq(-grid_max, grid_max, by = grid_unit), 
                               times = 2*grid_max/grid_unit + 1),
                       Y = rep(seq(-grid_max, grid_max, by = grid_unit), 
                               each = 2*grid_max/grid_unit + 1))
##  Use CancerAbstract::distanceGrid(), CancerAbstract::clusterGrid() 
##    to get Delaunay triangulations
grid_distance <- distanceGrid(Voronoi_centroid, tmp_grid[,1:2], weight = T)
grid_distance_cluster <- clusterGrid(grid_distance)
tmp_grid$Cluster <- grid_distance_cluster$Cluster
```


```{r}
weightedVoronoiPlot(Voronoi_centroid,
                    Voronoi_connections,
                    tmp_grid)
```




